name: Users me endpoint
vars:
  base_url: http://localhost:8080
  token_admin: admin

testcases:
  - name: get-users-me-admin
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users/me"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 200

  - name: get-users-me-invalid-token
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users/me"
        headers:
          Authorization: "Bearer invalid"
        assertions:
          - result.statuscode ShouldEqual 401

  - name: post-users
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.token_admin}}"
          Content-Type: application/json
        body: |
          {
            "email": "anormaluser@test.com"
          }
        assertions:
          - result.statuscode ShouldEqual 201
          - result.bodyjson.email ShouldEqual "anormaluser@test.com"
          - result.bodyjson.role ShouldEqual "default"
        vars:
          userid:
            from: result.bodyjson.id

  - name: post-users-mail-conflict
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.token_admin}}"
          Content-Type: application/json
        body: |
          {
            "email": "anormaluser@test.com"
          }
        assertions:
          - result.statuscode ShouldEqual 409

  - name: post-users-invalid-mail
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.token_admin}}"
          Content-Type: application/json
        body: |
          {
            "email": "invalid"
          }
        assertions:
          - result.statuscode ShouldEqual 400
  
  - name: post-users-missing-mail
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.token_admin}}"
          Content-Type: application/json
        body: |
          {}
        assertions:
          - result.statuscode ShouldEqual 400

  - name: post-users-invalid-token
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer invalid"
          Content-Type: application/json
        body: |
          {
            "email": "invalid"
          }
        assertions:
          - result.statuscode ShouldEqual 401

  - name: post-users-missing-token
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Content-Type: application/json
        body: |
          {
            "email": "invalid"
          }
        assertions:
          - result.statuscode ShouldEqual 401

  - name: get-users-admin
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson ShouldHaveLength 2

  - name: get-users-invalid-token
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer invalid"
        assertions:
          - result.statuscode ShouldEqual 401

  - name: get-users-missing-token
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users"
        assertions:
          - result.statuscode ShouldEqual 401
  
  - name: get-user
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users/{{.post-users.userid}}"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.id ShouldEqual "{{.post-users.userid}}"
          - result.bodyjson.email ShouldEqual "anormaluser@test.com"
          - result.bodyjson.role ShouldEqual "default"
          - result.bodyjson.read ShouldHaveLength 0
          - result.bodyjson.write ShouldHaveLength 0
        
  - name: get-user-invalid-token
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users/{{.post-users.userid}}"
        headers:
          Authorization: "Bearer invalid"
        assertions:
          - result.statuscode ShouldEqual 401

  - name: get-user-no-token
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users/{{.post-users.userid}}"
        assertions:
          - result.statuscode ShouldEqual 401

  - name: get-invalid-user
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users/invalid"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 404

  - name: create-session-for-default-user
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users/{{.post-users.userid}}/sessions"
        headers:
          Authorization: "Bearer {{.token_admin}}"
          Content-Type: application/json
        body: ""
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          sessionid:
            from: result.bodyjson.id

  - name: create-cascade-verifier-user
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.token_admin}}"
          Content-Type: application/json
        body: |
          {
            "email": "cascadeverifier@test.com",
            "read": ["{{.post-users.userid}}"]
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          userid:
            from: result.bodyjson.id

  - name: create-cascade-verifier-session
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users/{{.create-cascade-verifier-user.userid}}/sessions"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          sessionid:
            from: result.bodyjson.id

  - name: create-default-user-blob
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/blobs"
        headers:
          Authorization: "Bearer {{.create-session-for-default-user.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "file_type": "image/png",
            "width": 640,
            "height": 480,
            "ocr": "Cascade test blob"
          }
        assertions:
          - result.statuscode ShouldEqual 201
          - result.bodyjson.owner ShouldEqual "{{.post-users.userid}}"
        vars:
          blobid:
            from: result.bodyjson.id

  - name: create-default-user-song
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/songs"
        headers:
          Authorization: "Bearer {{.create-session-for-default-user.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "not_a_song": false,
            "blobs": [],
            "data": {
              "title": "Cascade Song",
              "sections": []
            }
          }
        assertions:
          - result.statuscode ShouldEqual 201
          - result.bodyjson.owner ShouldEqual "{{.post-users.userid}}"
        vars:
          songid:
            from: result.bodyjson.id

  - name: create-default-user-setlist
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/setlists"
        headers:
          Authorization: "Bearer {{.create-session-for-default-user.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "title": "Cascade Setlist",
            "songs": [
              { "id": "{{.create-default-user-song.songid}}", "nr": "1" }
            ]
          }
        assertions:
          - result.statuscode ShouldEqual 201
          - result.bodyjson.owner ShouldEqual "{{.post-users.userid}}"
        vars:
          setlistid:
            from: result.bodyjson.id

  - name: create-default-user-collection
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/collections"
        headers:
          Authorization: "Bearer {{.create-session-for-default-user.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "title": "Cascade Collection",
            "cover": "{{.create-default-user-blob.blobid}}",
            "songs": [
              { "id": "{{.create-default-user-song.songid}}", "nr": "1" }
            ]
          }
        assertions:
          - result.statuscode ShouldEqual 201
          - result.bodyjson.owner ShouldEqual "{{.post-users.userid}}"
        vars:
          collectionid:
            from: result.bodyjson.id

  - name: like-default-user-song
    steps:
      - type: http
        method: PUT
        url: "{{.base_url}}/api/v1/songs/{{.create-default-user-song.songid}}/likes"
        headers:
          Authorization: "Bearer {{.create-session-for-default-user.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "liked": true
          }
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.liked ShouldEqual true

  - name: get-users-me-default
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users/me"
        headers:
          Authorization: "Bearer {{.create-session-for-default-user.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.id ShouldEqual "{{.post-users.userid}}"
          - result.bodyjson.email ShouldEqual "anormaluser@test.com"
          - result.bodyjson.role ShouldEqual "default"
          - result.bodyjson.read ShouldHaveLength 0
          - result.bodyjson.write ShouldHaveLength 0

  - name: get-users-default
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.create-session-for-default-user.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 403

  - name: post-users-default
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.create-session-for-default-user.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "email": "invalid"
          }
        assertions:
          - result.statuscode ShouldEqual 403

  - name: get-user-default
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users/{{.post-users.userid}}"
        headers:
          Authorization: "Bearer {{.create-session-for-default-user.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 403

  - name: delete-user-default
    steps:
      - type: http
        method: DELETE
        url: "{{.base_url}}/api/v1/users/{{.post-users.userid}}"
        headers:
          Authorization: "Bearer {{.create-session-for-default-user.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 403

  - name: delete-user
    steps:
      - type: http
        method: DELETE
        url: "{{.base_url}}/api/v1/users/{{.post-users.userid}}"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.id ShouldEqual "{{.post-users.userid}}"
          - result.bodyjson.email ShouldEqual "anormaluser@test.com"
          - result.bodyjson.role ShouldEqual "default"
          - result.bodyjson.read ShouldHaveLength 0
          - result.bodyjson.write ShouldHaveLength 0

  - name: get-default-user-session-after-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/users/me"
        headers:
          Authorization: "Bearer {{.create-session-for-default-user.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 401

  - name: get-default-user-song-after-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/songs/{{.create-default-user-song.songid}}"
        headers:
          Authorization: "Bearer {{.create-cascade-verifier-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 404

  - name: get-default-user-setlist-after-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/setlists/{{.create-default-user-setlist.setlistid}}"
        headers:
          Authorization: "Bearer {{.create-cascade-verifier-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 404

  - name: get-default-user-collection-after-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/collections/{{.create-default-user-collection.collectionid}}"
        headers:
          Authorization: "Bearer {{.create-cascade-verifier-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 404

  - name: get-default-user-blob-after-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/blobs/{{.create-default-user-blob.blobid}}"
        headers:
          Authorization: "Bearer {{.create-cascade-verifier-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 404

  - name: delete-user-again
    steps:
      - type: http
        method: DELETE
        url: "{{.base_url}}/api/v1/users/{{.post-users.userid}}"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 404

  - name: delete-user-no-token
    steps:
      - type: http
        method: DELETE
        url: "{{.base_url}}/api/v1/users/{{.post-users.userid}}"
        assertions:
          - result.statuscode ShouldEqual 401

  - name: delete-invalid-user
    steps:
      - type: http
        method: DELETE
        url: "{{.base_url}}/api/v1/users/invalid"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 404
