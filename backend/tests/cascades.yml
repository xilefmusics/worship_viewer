name: Cascade regression suite
vars:
  base_url: http://localhost:8080
  token_admin: admin

# Coverage map
# - blob_user_cascade -> get-blob-after-user-delete
# - collection_user_cascade -> get-collection-after-user-delete
# - collection_cover_blob_cascade -> get-collection-after-cover-blob-delete
# - collection_song_remove -> get-collection-after-song-delete
# - like_user_cascade -> get-like-status-after-user-delete
# - like_song_cascade -> get-like-status-after-song-delete
# - session_user_cascade -> use-session-after-user-delete
# - setlist_user_cascade -> get-setlist-after-user-delete
# - setlist_song_remove -> get-setlist-after-song-delete
# - song_user_cascade -> get-song-after-user-delete
# - song_blob_remove -> get-song-blobs-after-blob-delete

testcases:
  # --- Shared fixtures for user deletion cascades ---
  - name: create-cascade-owner-user
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.token_admin}}"
          Content-Type: application/json
        body: |
          {
            "email": "cascade-owner@test.com"
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          userid:
            from: result.bodyjson.id

  - name: create-cascade-owner-session
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users/{{.create-cascade-owner-user.userid}}/sessions"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          sessionid:
            from: result.bodyjson.id

  - name: create-cascade-observer-user
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.token_admin}}"
          Content-Type: application/json
        body: |
          {
            "email": "cascade-observer@test.com",
            "read": ["{{.create-cascade-owner-user.userid}}"]
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          userid:
            from: result.bodyjson.id

  - name: create-cascade-observer-session
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users/{{.create-cascade-observer-user.userid}}/sessions"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          sessionid:
            from: result.bodyjson.id

  - name: create-cascade-owner-blob
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/blobs"
        headers:
          Authorization: "Bearer {{.create-cascade-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "file_type": "image/png",
            "width": 1024,
            "height": 768,
            "ocr": "Cascade owner blob"
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          blobid:
            from: result.bodyjson.id

  - name: create-cascade-owner-song
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/songs"
        headers:
          Authorization: "Bearer {{.create-cascade-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "not_a_song": false,
            "blobs": [],
            "data": {
              "title": "Cascade Owner Song",
              "sections": []
            }
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          songid:
            from: result.bodyjson.id

  - name: create-cascade-owner-collection
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/collections"
        headers:
          Authorization: "Bearer {{.create-cascade-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "title": "Cascade Owner Collection",
            "cover": "{{.create-cascade-owner-blob.blobid}}",
            "songs": [
              { "id": "{{.create-cascade-owner-song.songid}}", "nr": "1" }
            ]
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          collectionid:
            from: result.bodyjson.id

  - name: create-cascade-owner-setlist
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/setlists"
        headers:
          Authorization: "Bearer {{.create-cascade-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "title": "Cascade Owner Setlist",
            "songs": [
              { "id": "{{.create-cascade-owner-song.songid}}", "nr": "1" }
            ]
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          setlistid:
            from: result.bodyjson.id

  - name: create-like-target-song
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/songs"
        headers:
          Authorization: "Bearer {{.create-cascade-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "not_a_song": false,
            "blobs": [],
            "data": {
              "title": "Cascade Like Target",
              "sections": []
            }
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          songid:
            from: result.bodyjson.id

  - name: create-cascade-owner-like
    steps:
      - type: http
        method: PUT
        url: "{{.base_url}}/api/v1/songs/{{.create-like-target-song.songid}}/likes"
        headers:
          Authorization: "Bearer {{.create-cascade-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "liked": true
          }
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.liked ShouldEqual true

  - name: delete-cascade-owner
    steps:
      - type: http
        method: DELETE
        url: "{{.base_url}}/api/v1/users/{{.create-cascade-owner-user.userid}}"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 200

  - name: use-session-after-user-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/songs"
        headers:
          Authorization: "Bearer {{.create-cascade-owner-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 401

  - name: get-blob-after-user-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/blobs/{{.create-cascade-owner-blob.blobid}}"
        headers:
          Authorization: "Bearer {{.create-cascade-observer-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 404

  - name: get-song-after-user-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/songs/{{.create-cascade-owner-song.songid}}"
        headers:
          Authorization: "Bearer {{.create-cascade-observer-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 404

  - name: get-collection-after-user-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/collections/{{.create-cascade-owner-collection.collectionid}}"
        headers:
          Authorization: "Bearer {{.create-cascade-observer-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 404

  - name: get-setlist-after-user-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/setlists/{{.create-cascade-owner-setlist.setlistid}}"
        headers:
          Authorization: "Bearer {{.create-cascade-observer-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 404

  - name: get-like-status-after-user-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/songs/{{.create-like-target-song.songid}}/likes"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 404

  # --- Collection cover blob cascade ---
  - name: create-cover-owner-user
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.token_admin}}"
          Content-Type: application/json
        body: |
          {
            "email": "collection-cover@test.com"
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          userid:
            from: result.bodyjson.id

  - name: create-cover-owner-session
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users/{{.create-cover-owner-user.userid}}/sessions"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          sessionid:
            from: result.bodyjson.id

  - name: create-cover-blob
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/blobs"
        headers:
          Authorization: "Bearer {{.create-cover-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "file_type": "image/png",
            "width": 400,
            "height": 400,
            "ocr": "Cover Blob"
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          blobid:
            from: result.bodyjson.id

  - name: create-cover-song
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/songs"
        headers:
          Authorization: "Bearer {{.create-cover-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "not_a_song": false,
            "blobs": [],
            "data": {
              "title": "Cover Song",
              "sections": []
            }
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          songid:
            from: result.bodyjson.id

  - name: create-cover-collection
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/collections"
        headers:
          Authorization: "Bearer {{.create-cover-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "title": "Cover Cascade Collection",
            "cover": "{{.create-cover-blob.blobid}}",
            "songs": [
              { "id": "{{.create-cover-song.songid}}", "nr": "1" }
            ]
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          collectionid:
            from: result.bodyjson.id

  - name: delete-cover-blob
    steps:
      - type: http
        method: DELETE
        url: "{{.base_url}}/api/v1/blobs/{{.create-cover-blob.blobid}}"
        headers:
          Authorization: "Bearer {{.create-cover-owner-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 200

  - name: get-collection-after-cover-blob-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/collections/{{.create-cover-collection.collectionid}}"
        headers:
          Authorization: "Bearer {{.create-cover-owner-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 404

  # --- Song blob remove cascade ---
  - name: create-song-blob-user
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.token_admin}}"
          Content-Type: application/json
        body: |
          {
            "email": "song-blob-owner@test.com"
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          userid:
            from: result.bodyjson.id

  - name: create-song-blob-session
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users/{{.create-song-blob-user.userid}}/sessions"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          sessionid:
            from: result.bodyjson.id

  - name: create-song-blob
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/blobs"
        headers:
          Authorization: "Bearer {{.create-song-blob-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "file_type": "image/png",
            "width": 300,
            "height": 300,
            "ocr": "Song Blob"
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          blobid:
            from: result.bodyjson.id

  - name: create-song-with-blob
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/songs"
        headers:
          Authorization: "Bearer {{.create-song-blob-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "not_a_song": false,
            "blobs": ["{{.create-song-blob.blobid}}"],
            "data": {
              "title": "Song With Blob",
              "sections": []
            }
          }
        assertions:
          - result.statuscode ShouldEqual 201
          - result.bodyjson.blobs ShouldHaveLength 1
        vars:
          songid:
            from: result.bodyjson.id

  - name: delete-song-blob
    steps:
      - type: http
        method: DELETE
        url: "{{.base_url}}/api/v1/blobs/{{.create-song-blob.blobid}}"
        headers:
          Authorization: "Bearer {{.create-song-blob-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 200

  - name: get-song-blobs-after-blob-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/songs/{{.create-song-with-blob.songid}}"
        headers:
          Authorization: "Bearer {{.create-song-blob-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.blobs ShouldHaveLength 0

  # --- Song deletion cascades (lists & likes) ---
  - name: create-song-remove-owner-user
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users"
        headers:
          Authorization: "Bearer {{.token_admin}}"
          Content-Type: application/json
        body: |
          {
            "email": "song-remove-owner@test.com"
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          userid:
            from: result.bodyjson.id

  - name: create-song-remove-owner-session
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/users/{{.create-song-remove-owner-user.userid}}/sessions"
        headers:
          Authorization: "Bearer {{.token_admin}}"
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          sessionid:
            from: result.bodyjson.id

  - name: create-song-remove-keep
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/songs"
        headers:
          Authorization: "Bearer {{.create-song-remove-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "not_a_song": false,
            "blobs": [],
            "data": {
              "title": "Keep Song",
              "sections": []
            }
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          songid:
            from: result.bodyjson.id

  - name: create-song-remove-delete
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/songs"
        headers:
          Authorization: "Bearer {{.create-song-remove-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "not_a_song": false,
            "blobs": [],
            "data": {
              "title": "Delete Song",
              "sections": []
            }
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          songid:
            from: result.bodyjson.id

  - name: create-song-remove-collection
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/collections"
        headers:
          Authorization: "Bearer {{.create-song-remove-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "title": "Song Remove Collection",
            "cover": "cover-remove",
            "songs": [
              { "id": "{{.create-song-remove-keep.songid}}", "nr": "1" },
              { "id": "{{.create-song-remove-delete.songid}}", "nr": "2" }
            ]
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          collectionid:
            from: result.bodyjson.id

  - name: create-song-remove-setlist
    steps:
      - type: http
        method: POST
        url: "{{.base_url}}/api/v1/setlists"
        headers:
          Authorization: "Bearer {{.create-song-remove-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "title": "Song Remove Setlist",
            "songs": [
              { "id": "{{.create-song-remove-keep.songid}}", "nr": "1" },
              { "id": "{{.create-song-remove-delete.songid}}", "nr": "2" }
            ]
          }
        assertions:
          - result.statuscode ShouldEqual 201
        vars:
          setlistid:
            from: result.bodyjson.id

  - name: create-song-remove-like
    steps:
      - type: http
        method: PUT
        url: "{{.base_url}}/api/v1/songs/{{.create-song-remove-delete.songid}}/likes"
        headers:
          Authorization: "Bearer {{.create-song-remove-owner-session.sessionid}}"
          Content-Type: application/json
        body: |
          {
            "liked": true
          }
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.liked ShouldEqual true

  - name: delete-song-remove-target
    steps:
      - type: http
        method: DELETE
        url: "{{.base_url}}/api/v1/songs/{{.create-song-remove-delete.songid}}"
        headers:
          Authorization: "Bearer {{.create-song-remove-owner-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 200

  - name: get-collection-after-song-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/collections/{{.create-song-remove-collection.collectionid}}"
        headers:
          Authorization: "Bearer {{.create-song-remove-owner-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.songs ShouldHaveLength 1
          - result.bodyjson.songs.0.id ShouldEqual "{{.create-song-remove-keep.songid}}"

  - name: get-setlist-after-song-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/setlists/{{.create-song-remove-setlist.setlistid}}"
        headers:
          Authorization: "Bearer {{.create-song-remove-owner-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.songs ShouldHaveLength 1
          - result.bodyjson.songs.0.id ShouldEqual "{{.create-song-remove-keep.songid}}"

  - name: get-like-status-after-song-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/songs/{{.create-song-remove-delete.songid}}/likes"
        headers:
          Authorization: "Bearer {{.create-song-remove-owner-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 404

  - name: get-song-after-song-delete
    steps:
      - type: http
        method: GET
        url: "{{.base_url}}/api/v1/songs/{{.create-song-remove-delete.songid}}"
        headers:
          Authorization: "Bearer {{.create-song-remove-owner-session.sessionid}}"
        assertions:
          - result.statuscode ShouldEqual 404

